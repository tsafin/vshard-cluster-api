## CRUD operations
### Select
`vshard.select` - поиск данных в спейсе по набору условий. Если среди условий фильтрации есть сравнение поля 
шардирования с его полным значением, то запрос будет выполнен на узле, хранящем бакет этого ключа. Иначе запрос 
будет выполнен на всех узлах кластера, и для формирования результата неявно выполнен map-reduce результатов.

Формат запроса:
```lua
local result, err = vshard.select(space, conditions, opts) 
```

* `space` - имя спейса
* `conditions` - массив условий фильтрации спейса в формате {operator, field_name, value} (см. [документацию](https://www.tarantool.io/en/doc/1.10/reference/reference_lua/box_space/#box-space-update))
* `opts` - дополнительные опции запроса:
  * `limit` - максимальное число кортежей в результате 
  * `after` - кортеж, после которого должны быть выбраны следующие за ним кортежи.
  * `balance` - boolean флаг, задающий разрешение на чтение с реплик (по-умолчанию, true).
  * `explain` - boolean флаг. Если задан в true, то вместо результата запроса будет возвращен план запроса
   (по-умолчанию, false).
* `result` - массив кортежей, удовлетворяющие условиям запроса
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.select("accounts", {{'=', 'acc_type', 'saving'}, {'>', 'amount', 0}}, {limit = 2}) 
--[[ sample response
{{"00012345678", "saving", {"1000", "840"}},
{"99912345678", "saving", {"50000", "643"}}}
]]--
-- select data for the next page
local result, err = vshard.select("accounts", {{'=', 'acc_type', 'saving'}, {'>', 'amount', 0}}, 
    {limit = 2, after = result[1]}) 
--[[ sample response
{{"4678213812", "saving", {"2000", "840"}}}
]]--
```
---
`vshard.get` - поиск кортежа по ключу.

Формат запроса:
```lua
local result, err = vshard.get(space, key, opts) 
```

* `space` - имя спейса
* `key` - значение индексного ключа
* `opts` - дополнительные опции запроса:
  * `balance` - boolean флаг, задающий разрешение на чтение с реплик (по-умолчанию, true).
* `result` - кортеж, найденный в спейсе по ключу `key` или `nil`
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.get("accounts", '99912345678')
--[[ sample response
{"99912345678", "saving", {"1000", "840"}}
]]--
```
---
### Insert
`vshard.insert` - сохранение кортежа в спейсе.

Формат запроса:
```lua
local result, err = vshard.insert(space, tuple) 
```

* `space` - имя спейса
* `tuple` - кортеж с данными
* `result` - кортеж, вставленный в спейс
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.insert("accounts", {"99912345678", "saving", "50000"})
--[[ sample response
{"99912345678", "saving", "50000"}
]]--
```
---
`vshard.batch_insert` - пакетное сохранение массива кортежей в спейсе.

Формат запроса:
```lua
local result, err = vshard.batch_insert(space, tuples, opts) 
```

* `space` - имя спейса
* `tuples` - массив кортежей для сохранения
* `opts` - дополнительные опции запроса:
  * `batch_size` - число кортежей в одном батче (по-умолчанию 0, т.е. обработка всех кортежей за раз)
  * `skip_result` - boolean флаг, указывающий о необходимости возврата данных в `result`
* `result` - массив кортежей, сохраненных в спейсе в последнем выполненном батче
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.batch_insert("accounts",
    {{"99912345678", "saving", "50000"},{"99912345678", "saving", {"50000", "643"}}})
```
---
### Put
`vshard.put` - вставка или замена существующего кортежа в спейсе.

Формат запроса:
```lua
local result, err = vshard.put(space, tuples) 
```

* `space` - имя спейса
* `tuple` - кортеж с данными
* `result` - кортеж, обновленный или вставленный в спейс
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.put("accounts", {"00012345678", "saving", "1000"})
--[[ sample response
{"00012345678", "saving", "1000"}
]]--
```
---
`vshard.batch_put` - вставка новых и обновление существующих кортежей в спейсе.

Формат запроса:
```lua
local result, err = vshard.batch_put(space, tuples, opts) 
```

* `space` - имя спейса
* `tuples` - массив кортежей для сохранения или замены
* `opts` - дополнительные опции запроса:
  * `batch_size` - число кортежей в одном батче (по-умолчанию 0, т.е. обработка всех кортежей за раз)
  * `skip_result` - boolean флаг, указывающий о необходимости возврата данных в `result`
* `result` - массив кортежей, сохраненных/обновленных в спейсе
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.batch_put(accounts,
    {{"99912345678", "saving", "50000"},{"99912345678", "saving", {"50000", "643"}}})
```
---
### Update
`vshard.update` - обновление кортежа в спейсе

Формат запроса:
```lua
local result, err = vshard.update(space, key, operations, opts) 
```

* `space` - имя спейса
* `key` - значение индексного ключа кортежа
* `operations` - массив операций изменения данных в кортеже
* `opts` - дополнительные опции запроса:
  * `cas_cond` - операция проверки при оптимистичной блокировке
* `result` - кортеж, обновленный в спейсе
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.update("accounts", "99912345678", {{'+', 'amount', '20000'}})
--[[ sample response
{"99912345678", "saving", "70000"}
]]--
```
---
`vshard.batch_update` - пакетное обновление кортежей в спейсе.

Формат запроса:
```lua
local result, err = vshard.batch_update(space, conditions, operations, params, opts) 
```

* `space` - имя спейса
* `conditions` - массив условий поиска кортежей для обновления
* `operations` - массив операций изменения данных в кортеже
* `params` - массив значений параметров для операций и условий
* `opts` - дополнительные опции запроса:
  * `batch_size` - число кортежей в одном батче (по-умолчанию 0, т.е. обработка всех кортежей за раз)
  * `skip_result` - boolean флаг, указывающий о необходимости возврата данных в `result`
* `result` - массив кортежей, обновленных в последнем выполненном батче
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.batch_update("accounts",
    {{'=', 'acc_id', ':account_id'}}, -- conditions
    {{'+', 'amount', ':add_amount'}}, -- operations
    {{account_id = "99912345678", add_amount = 20000},{account_id = "00012345678", add_amount = 1000}}) -- params
```
---
### Upsert
`vshard.upsert` - вставка нового или обновление существующего кортежа в спейсе.

Формат запроса:
```lua
local result, err = vshard.upsert(space, tuple, operations, opts) 
```

* `space` - имя спейса
* `tuple` - кортед с данными
* `operations` - массив операций изменения данных в кортеже
* `opts` - дополнительные опции запроса:
  * `cas_cond` - операция проверки при оптимистичной блокировке
* `result` - `nil`
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.upsert("accounts",
    {"99912345678", "saving", "50000"},
    {{'=', 'amount', '20000'}, {'=', 'acc_type', 'new'}})
```
---
`vshard.batch_upsert` - пакетное выполнение операции `upsert`.

Формат запроса:
```lua
local result, err = vshard.batch_upsert(space, tuples, operations, params, opts) 
```

* `space` - имя спейса
* `tuples` - массив кортежей для вставки или обновления
* `operations` - массив массивов операций изменения в кортежах. К кортежу по индексу n (tuples[n]) будут применены операции operations[n].
* `params` - массив значений параметров для операций и условий
* `opts` - дополнительные опции запроса:
  * `batch_size` - число кортежей в одном батче (по-умолчанию 0, т.е. обработка всех кортежей за раз)
  * `skip_result` - boolean флаг, указывающий о необходимости возврата данных в `result`
* `result` - массив кортежей, обновленных в последнем выполненном батче
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.batch_upsert("accounts",
    {{"99912345678", "saving", "50000"},{"00012345678", "saving", {"50000", "643"}}}, -- tuples
    {{{'+', 'amount', '5000'}}, {{'-', 'amount', '5000'}}}) -- params
```
---
### Delete
`vshard.delete` - удаление кортежа из спейса по первичному ключу.

Формат запроса:
```lua
local result, err = vshard.delete(space, key) 
```

* `space` - имя спейса
* `key` - значение первичного ключа
* `result` - удаленный кортеж
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.delete("accounts", "00012345678")
--[[ sample response
{"00012345678", "saving", "1000"}
]]--
```
---
`vshard.batch_delete` - удаление кортежей из спейса условию.

Формат запроса:
```lua
local result, err = vshard.batch_delete(space, conditions, params, opts) 
```

* `space` - имя спейса
* `conditions` - массив условий поиска кортежей для удаления
* `params` - массив значений параметров для условий поиска
* `opts` - дополнительные опции запроса:
  * `batch_size` - число кортежей в одном батче (по-умолчанию 0, т.е. обработка всех кортежей за раз)
  * `skip_result` - boolean флаг, указывающий о необходимости возврата данных в `result`
* `result` - массив кортежей, удаленных в последнем выполненном батче
* `err` - код ошибки, если при выполнении запроса произошла исключительная ситуация
  
Пример:
```lua
local result, err = vshard.batch_delete("accounts", 
    {{'=', 'acc_type', 'saving'}}) -- conditions
--[[ sample response
{{"00012345678", "saving", {"1000", "840"}},
{"99912345678", "saving", {"50000", "643"}}}
]]--
```
---
